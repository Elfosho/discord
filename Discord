import discord
from discord.ext import commands, tasks
import asyncio
from datetime import datetime

intents = discord.Intents.default()
intents.message_content = True  # обязательно включить в 2025
intents.voice_states = True

bot = commands.Bot(command_prefix="!", intents=intents)

# Словарь: user_id -> задача asyncio (чтобы можно было отменить)
timers = {}


async def kick_after_delay(member: discord.Member, delay_minutes: int):
    await asyncio.sleep(delay_minutes * 60)

    if member.voice and member.voice.channel:
        await member.move_to(None)  # это и есть кик из голосоввого канала
        try:
            await member.send(f"⏰ Время вышло! Ты был отключён от голосового канала (таймер на {delay_minutes} мин).")
        except:
            pass

    # Удаляем таймер после выполнения
    timers.pop(member.id, None)


@bot.command(name="таймаут")
async def timeout_cmd(ctx, minutes: str = None):
    if minutes is None:
        await ctx.send("Использование: `!таймаут 30` (через сколько минут кикнуть) или `!таймаут стоп`")
        return

    if not ctx.author.voice or not ctx.author.voice.channel:
        await ctx.send("Ты должен быть в голосовом канале, чтобы ставить себе таймаут.")
        return

    if minutes.lower() in ["стоп", "отмена", "cancel", "stop"]:
        if ctx.author.id in timers:
            timers[ctx.author.id].cancel()
            timers.pop(ctx.author.id)
            await ctx.send("⏰ Твой таймер успешно отменён.")
        else:
            await ctx.send("У тебя нет активного таймаута.")
        return

    try:
        minutes_int = int(minutes)
    except:
        await ctx.send("Напиши нормальное число минут, а не бред.")
        return

    if minutes_int <= 0:
        await ctx.send("Минуты должны быть больше 0.")
        return
    if minutes_int > 240:  # лимит 4 часа
        await ctx.send("Максимум 240 минут (4 часа). Не наглей.")
        return

    # Если уже был таймер — отменяем старый
    if ctx.author.id in timers:
        timers[ctx.author.id].cancel()

    # Создаём новый таймер
    task = bot.loop.create_task(kick_after_delay(ctx.author, minutes_int))
    timers[ctx.author.id] = task

    hours = minutes_int // 60
    mins = minutes_int % 60
    time_text = f"{hours} ч {mins} мин" if hours else f"{mins} мин"

    await ctx.send(f"⏰ Окей, {ctx.author.mention}, через **{time_text}** тебя кикнет из голосового канала.")


@bot.event
async def on_ready():
    print(f"Бот {bot.user} запущен и готов кикать лентяев")


bot.run("")
